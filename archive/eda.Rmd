---
title: Policy & Abortion EDA
author: Kayla Manning
output: 
  pdf_document:
    latex_engine: xelatex
---

```{r setup, echo=FALSE, warning=FALSE, message=FALSE}

knitr::opts_chunk$set(message = FALSE,
                      warning = FALSE,
                      echo = FALSE)

# loading libraries as needed

{
  # basic cleaning tasks
  
  library(tidyverse)
  library(readxl)
  library(janitor)
  library(zoo)
  
  # dealing with NA data
  
  library(naniar)
  
  # mixed effects modeling
  
  library(lme4)
  
  # helping format tables
  
  library(reshape2)
  library(kableExtra)
  
  # for maps
  
  library(maps)
  library(gganimate)
  library(transformr)
}

# data <3

{
  # reading in gestational data that I scraped

  gestation <- read_csv('raw-data/scraped/gestational_combined.csv') %>% 
    select(-X1) %>% distinct()
  
  # looping through the different excel sheets to get the abortion count data
  
  {
    abortion_counts <- tibble()
    for (y in 2010:2019) {
      storage <- read_excel('raw-data/downloads/abortions_2010-2019.xls', 
                            skip = 1, sheet = as.character(y)) %>% 
        select(-1) %>% 
        clean_names() %>% 
        mutate(year = y) %>% 
        rename(state_location = state_area) %>% 
        select(state_location, year, everything())
      abortion_counts <- bind_rows(abortion_counts, storage)
    }
  }
  
  # reading in the birth & policy data
  
  births <- read.delim('raw-data/downloads/births_2007-2020.txt') %>% 
    clean_names() %>% 
    select(-c(notes, state_code, year_code))
  policies <- read_csv('raw-data/clean_policies.csv')
}

```

# Abortion data

First I will see which years the states did not fully report the data under the below criteria:

** Reporting area did not report, or only reported by occurrence; because abortion numbers by residence are available only from other reporting areas where residents obtained abortions, data by state/area of maternal residence should be interpreted with caution. 	

```{r didnt_report}

# I'm curious to see if all of the same states have "*" in every year

abortion_counts %>% 
  select(state_location, year) %>% 
  mutate(didnt_report = as.numeric(str_detect(state_location, fixed('**')))) %>% 
  group_by(state_location) %>% 
  summarise(nonreport_yrs = sum(didnt_report)) %>% 
  filter(nonreport_yrs != 0)

# want to get a list of years in which they didn't report... I should exclude
# these states from the analysis because they wouldn't have actually had 0
# abortions... it is an issue that CA didn't report though because they would
# likely have a high number since they're very democratic

nonreporting_states <- c('California', 'District of Columbia', 
                         'Florida', 'Maryland', 'New Hampshire')
nonreport_years_df <- abortion_counts %>% 
  drop_na(state_location) %>% 
  filter(str_detect(state_location, fixed('**')) | is.na(total_by_location_of_service)) %>% 
  select(state_location, year) %>% 
  group_by(state_location) %>% 
  summarise(years = list(unique(year)))

nonreport_years_df %>% 
  filter(str_detect(state, nonreporting_states[1]))

missing_states <- sapply(nonreport_years_df$state_location, 
       function (x) str_replace_all(str_to_lower(str_remove_all(x, 
                                                                fixed('*'))), 
                                    ' ', '_'))

# getting a vector of each year that the data is missing for the respective state

{
  i <- 1
  for (state in missing_states) {
    vector_name <- paste0('missingyrs_', state)
    assign(vector_name, nonreport_years_df$years[i][[1]])
    i <- i+1
  }
}

# I will want to put this info in a table

missing_state_yr_table <- tibble()
for (i in 1:length(missing_states)) {
  this_state <- cbind(rep(missing_states[i], length(nonreport_years_df$years[[i]])),
      nonreport_years_df$years[[i]]) %>% 
  as.data.frame()
  missing_state_yr_table <- rbind(missing_state_yr_table, this_state)
}

# formatting the table... why am I missing Wyoming?

missing_state_yr_table %>% 
  rename(state = V1, year = V2) %>% 
  dcast(state ~ year) %>% 
  mutate(across(2:ncol(.), function(x) ifelse(is.na(x), '', 'X'))) %>% 
  mutate(state = str_replace(str_to_title(str_replace_all(state, '_', ' ')),
                             ' Of ', ' of ')) %>% 
  rename(State = state) %>% 
  kable(booktabs = TRUE)


```

Next, I check whether or not these asterisks correspond with states that have missing in-state data. That appears to be the case in most instances, except there are two years where DC did not report any in-state abortions and 10 years where Wyoming did not report any in-state abortions.

```{r abortion_long}

# replacing missing data with NA values

abortion_counts <- abortion_counts %>% 
  mutate(across(everything(), function(x) na_if(x, '--')))

# converting df to long format

abortion_long <- abortion_counts %>% 
  pivot_longer(alabama:ncol(.), 
               names_to = 'state_residence', 
               values_to = 'count') %>% 
  mutate(state_residence = str_replace_all(state_residence, '_', ' ')) %>% 
  mutate(across(c(state_location, state_residence), str_to_title),
         count = as.integer(count)) %>% 
  mutate(across(c(state_location, state_residence), 
                function(x) str_replace(x, ' Of ', ' of ')))

```

```{r out_of_state_counts}

# getting top out-of-state abortions, separated by year

abortion_long %>% 
  filter(state_location != state_residence,
         !str_detect(state_residence, 'Location'),
         !str_detect(state_residence, 'Residence'),
         !str_detect(state_location, 'Total')) %>% 
  filter(!(str_detect(state_location, 'New York') & 
             str_detect(state_residence, 'New York'))) %>% 
  arrange(desc(count))

# doing the same thing, but aggregated across all years in the data

summarize <- dplyr::summarize
abortion_long %>% 
  filter(state_location != state_residence,
         !str_detect(state_residence, 'Location'),
         !str_detect(state_residence, 'Residence'),
         !str_detect(state_location, 'Total')) %>% 
  filter(!(str_detect(state_location, 'New York') & 
             str_detect(state_residence, 'New York'))) %>% 
  group_by(state_location, state_residence) %>% 
  summarize(count = sum(count)) %>% 
  arrange(desc(count))

# also worth exploring top 10 by total by location of service

abortion_long %>% 
  filter(str_detect(state_residence, 'Total'),
         !str_detect(state_location, 'Total')) %>% 
  arrange(desc(count))

# aggregating top locations across all years

abortion_long %>% 
  filter(str_detect(state_residence, 'Total'),
         !str_detect(state_location, 'Total')) %>% 
  group_by(state_location) %>% 
  summarize(count = sum(count)) %>% 
  arrange(desc(count))

# out-of-state to in-state ratios

abortion_long %>% 
  mutate(across(c(state_residence, state_location), 
                function (x) str_remove_all(x, fixed('*')))) %>% 
  mutate(same_state = state_location == state_residence) %>% 
  group_by(state_location, same_state) %>% 
  summarise(aggregated = sum(count, na.rm = TRUE), .groups = 'drop') %>% 
  filter(!is.na(same_state)) %>% 
  pivot_wider(names_from = same_state, values_from = aggregated,
              names_prefix = 'instate') %>% 
  mutate(out_in_ratio = instateFALSE / instateTRUE) %>% 
  arrange(desc(out_in_ratio))

```

```{r rates_metrics}

# I want states with highest abortion rates... dropping NAs in abortion counts
# for now

abortion_rates <- abortion_long %>% 
  inner_join(births, by = c('state_location' = 'state', 'year')) %>% 
  mutate(in_state = case_when(state_location == state_residence ~ 'in_state',
                              str_detect(state_residence, 'Total') ~ 'total',
                              TRUE ~ 'out_of_state')) %>% 
  group_by(state_location, year, in_state, births, total_population) %>% 
  summarise(abortions = sum(count, na.rm = TRUE)) %>% 
  summarize(abortion_per_1k_births = abortions / (births / 1000),
            abortion_per_100k_pop = abortions / (total_population / 100000),
            .groups = 'drop') %>% 
  select(-births)

# visualizing abortion rates per population & births... highly correlated. for
# substantive reasons (since birth counts include non-residents & my question
# has to do with abortions as a function of births rather than a function of
# residents) & to control for female population, I will do abortions per births

abortion_rates %>% 
  ggplot(aes(abortion_per_1k_births, abortion_per_100k_pop)) +
  geom_point() +
  geom_smooth(method = 'lm') +
  theme_minimal() +
  labs(title = 'Abortion rates as a function of population vs total births',
       subtitle = 
         paste('Correlation of', round(cor(abortion_rates$abortion_per_100k_pop,
                                           abortion_rates$abortion_per_1k_births), 3)))

```

# Policy data

```{r policy_counts}

# printing as-of dates for my policy years

policies %>% 
  select(year, as_of) %>% 
  distinct()

# getting counts of different policy types over the years

policies %>% 
  select(-c(state, as_of, accessed)) %>% 
  group_by(year, policy, level) %>% 
  summarize(n = n())

# doing the same but across all years... seeing most popular policies

policies %>% 
  select(-c(state, as_of, accessed)) %>% 
  group_by(policy, level) %>% 
  summarize(n = n(), .groups = 'drop') %>% 
  drop_na(level) %>% 
  arrange(desc(n))

# seeing how many enjoined policies there are... partial birth ban isn't really
# considered harsh since it's a very common ban on late term pregnancies, so I
# think it's okay to exclude enjoined observations... in addition, previous work
# by Blum et al. found that a parental notification statute passed with judicial
# bypass procedures had little impact on decision-making of minors obtaining
# abortions (i.e. I don't think having an enjoined policy, through a similar
# legal loophole, would be much different but I should consult with Henry or
# someone else about that once I get to writing)

policies %>% 
  select(-c(state, as_of, accessed)) %>% 
  filter(level == 'Enjoined') %>% 
  group_by(policy, level) %>% 
  summarize(n = n(), .groups = 'drop') %>% 
  arrange(desc(n))

```

# Abortions & births

```{r abortion_birth_graphs}

# checked and the only columns that didn't join were NYC (but NY state did) &
# 'Total by Residence'

abortion_births <- abortion_long %>% 
  mutate(state_location = str_remove_all(state_location, '[^A-Za-z0-9 ]'),
         state_location = str_replace_all(state_location, 'New York State', 'New York')) %>% 
  inner_join(select(births, state, year, births, total_population), 
             by = c('state_location' = 'state', 'year')) %>% 
  select(year, state_location, state_residence, count, births, total_population) %>% 
  rename(abortions = count)

# making some faceted plots

for (i in 1:5) {
  max_index <- i*10
  min_index <- max_index-9
  g <- abortion_births %>% 
    filter(state_residence == 'Total By Location of Service') %>% 
    drop_na(abortions) %>% 
    group_by(state_location, year) %>% 
    summarise(abortion_birth_ratio = sum(abortions) / sum(births),
              .groups = 'drop') %>% 
    filter(state_location %in% state.name[min_index:max_index]) %>% 
    ggplot(aes(year, abortion_birth_ratio)) +
    geom_point() +
    theme_classic() +
    labs(title = 'Abortion-to-birth ratio in the states over time',
         caption = 'Excluding NA observations',
         x = 'Year',
         y = 'Abortion rate') +
    scale_x_continuous(breaks = seq(2010, 2019, 2)) +
    geom_smooth() +
    facet_wrap(~state_location) +
    scale_y_continuous(limits = c(0, 0.4))
  print(g)
}

# want to see which state has had the greatest change in rate across the 9 year
# period

abortion_births %>% 
    filter(state_residence == 'Total By Location of Service') %>% 
    drop_na(abortions) %>% 
    group_by(state_location, year) %>% 
    summarise(abortion_birth_ratio = sum(abortions) / sum(births),
              .groups = 'drop') %>% 
  filter(year %in% c(2010, 2019)) %>% 
  pivot_wider(names_from = year, values_from = abortion_birth_ratio, names_prefix = 'x') %>% 
  mutate(change = x2019-x2010,
         state_location = fct_reorder(state_location, change)) %>% 
  drop_na(change) %>% 
  select(-c(x2010:x2019)) %>% 
  arrange(desc(change)) %>% 
  ggplot(aes(state_location, change)) +
  geom_col() +
  coord_flip() +
  labs(title = 'Change in abortion-to-birth ratio from 2010 to 2019',
       caption = 'Excludes states that did not report data for either of the two years',
       y = 'Change in abortion rate from 2010 to 2019',
       x = 'State of procedure')

```

# Gestational counts

```{r missing_gestat}

# there's a lot of missing data, so I should visualize missingness first

gestation
gg_miss_var(gestation)

# only 80% of the rows have matching total reported abortions and missing
# values... this indicates that there are many rows where there were negligible
# observations, so it is important to be mindful of this in any analysis

gestation  %>% 
  mutate(sum_all = select(., x0_13:x21) %>% rowSums(na.rm = TRUE),
         total_equals_sum = total_reported == sum_all * 1) %>% 
  pull(total_equals_sum) %>% 
  mean()

# checking proportion of observations in each category that are NA for each
# state (so not reported or a negligible amount were reported)

gestation %>% 
  pivot_longer(x0_13:x21, names_to = 'window') %>% 
  mutate(value = is.na(value)) %>% 
  group_by(state, window) %>% 
  summarize(prop_na = mean(value), .groups = 'drop') %>% 
  pivot_wider(names_from = window, values_from = prop_na)

# WY is excluded from every year except 2007 and 2019... what is the difference
# between NA and 0? it's because WY only reported for <=8 but had negligible
# counts for 9-13 and 14-15... for this reason I may just exclude WY from
# gestational calculations since the unknowns are split across pre- and post-13
# weeks

gestation %>% 
  filter(state == 'Wyoming')

```

```{r late_vs_early}

# now I want to get counts for pre13 and post13... since we have these missing
# counts, I will subtract total_report - x0_13 to get the post13 (which will
# hopefully pick up on the abortions that were excluded for having low counts in
# specific windows)

late_early_df <- gestation %>% 
  filter(state != 'Wyoming') %>% 
  mutate(post13 = total_reported - x0_13,
         prop_late = post13 / total_reported) %>% 
  rename(pre13 = x0_13) %>% 
  select(state, year, pre13, post13) 

```

# Abortion & gestation combined

```{r joining_abortion_gestation}

# note that several observations are dropped if they don't report late-term abortions

abortion_births %>% 
  anti_join(late_early_df, by = c('year', 'state_location' = 'state'))

abortion_gestation_combined <- abortion_births %>% 
  inner_join(late_early_df, by = c('year', 'state_location' = 'state'))


```

# Gestation & policies combined

```{r policy_viz}

policy_scores <- read_csv('raw-data/policy_scores.csv')

policy_scores %>% 
  ggplot(aes(interstate_score, intrastate_score)) +
  geom_point() +
  labs(title = 'Intrastate score vs. interstate score (no clear relationship)') +
  geom_smooth()

policy_scores %>% 
  filter(state == 'Texas') %>% 
  pivot_longer(intrastate_score:interstate_score, names_to = 'type') %>% 
  ggplot(aes(year, value, color = type)) +
  geom_point() +
  labs(title = 'Intrastate / interstate scores vs. year in TX (no clear relationship)',
       subtitle = 'I really should not make this comparison because they are totally different scales') +
  geom_smooth()

# putting states in categories similar to Kaufman et al.

category_placements <- policy_scores %>% 
  pivot_longer(intrastate_score:interstate_score) %>% 
  group_by(name) %>% 
  mutate(first_cutoff = quantile(value, 1/3),
            second_cutoff = quantile(value, 2/3)) %>% 
  mutate(low = value <= first_cutoff,
         med = value > first_cutoff & value <= second_cutoff,
         high = value > second_cutoff) %>% 
  select(-c(first_cutoff, second_cutoff, value)) %>% 
  pivot_longer(low:high, names_to = 'category', values_to = 'placement') %>% 
  filter(placement) %>% 
  select(-placement) %>% 
  pivot_wider(names_from = name, values_from = category) %>% 
  mutate(within_between = paste(intrastate_score, interstate_score, sep = '-'),
         within_between = fct_relevel(within_between,
                                      levels = c('low-low', 'low-med', 'low-high',
                                                 'med-low', 'med-med', 'med-high',
                                                 'high-low', 'high-med', 'high-high'))) %>% 
  select(-c(intrastate_score, interstate_score))

# seeing overall breakdown between the categories

category_placements %>% 
  count(within_between)
category_placements %>% 
  count(within_between) %>% 
  ggplot(aes(within_between, n)) +
  geom_col() +
  labs(title = 'Substantial counts in each of the 9 policy categories',
       x = 'Intrastate-interstate score categories')

# making sure that states move around the 9 different categories

category_placements %>% 
  count(state, within_between) %>% 
  arrange(desc(n)) %>% 
  head(10)

# checking out distribution by year

category_placements %>% 
  count(year, within_between) %>% 
  ggplot(aes(as_factor(year), n, fill = within_between)) +
  geom_col(position = 'dodge') +
  labs(title = 'Certain policy categories tend to dominate certain years')

category_placements %>% 
  count(year, within_between) %>% 
  ggplot(aes(within_between, n)) +
  coord_flip() +
  facet_wrap(~year) +
  geom_col(position = 'dodge') +
  labs(title = 'Overall, we go from a less strict landscape to more strict \nlandscape with time')

# want to visualize how it changes with time

category_placements %>% 
  count(year, within_between) %>% 
  arrange(desc(n))

category_placements %>% 
  count(year, within_between) %>% 
  ggplot(aes(within_between, n)) +
  geom_col() +
  transition_states(year) +
  labs(title = 'Policy category breakdown in {closest_state}')

```

```{r policy_maps}

# mapping the inter/intra scores on a map, animating by year
# loading US map data

states <- map_data('state')

map_policy_df <- policy_scores %>% 
  mutate(state = str_to_lower(state)) %>% 
  inner_join(states, by = c('state' = 'region'))

# making ggplot animations

map_policy_df %>%
  ggplot() +
  geom_polygon(aes(long, lat, group=group, fill = intrastate_score),
               color = 'black') +
  transition_states(year) +
  scale_fill_gradient2(low = 'blue',
                       mid = 'white',
                       high = 'red',
                       midpoint = 6,
                       labels = c(0, 3, 6, 9, 12)) +
  coord_fixed() +
  labs(title = "Within-state policy scores in {closest_state}") +
  theme(panel.background = element_blank(),
        axis.text = element_blank(),
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank())

map_policy_df %>%
  ggplot() +
  geom_polygon(aes(long, lat, group=group, fill = interstate_score),
               color = 'black') +
  transition_states(year) +
  scale_fill_gradient2(low = 'blue',
                       mid = 'white',
                       high = 'red',
                       midpoint = 6,
                       labels = c(0, 3, 6, 9, 12)) +
  coord_fixed() +
  labs(title = "Interstate policy scores in {closest_state}") +
  theme(panel.background = element_blank(),
        axis.text = element_blank(),
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank())

# now just doing intrastate for 2010 and 2019 side-by-side

map_policy_df %>% 
  filter(year %in% c(2010, 2019)) %>% 
  ggplot() +
  geom_polygon(aes(long, lat, group=group, fill = intrastate_score),
               color = 'black') +
  scale_fill_gradient2(high = 'red') +
  coord_fixed() +
  facet_wrap(~year, nrow = 2)+
  labs(title = 'Intrastate scores for 2010 and 2019') +
  theme(panel.background = element_blank(),
        axis.text = element_blank(),
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank())

# seeing the change in hostility

map_policy_df %>% 
  filter(year %in% c(2010, 2019)) %>% 
  select(-interstate_score) %>% 
  pivot_wider(names_from = year, values_from = intrastate_score, names_prefix = 'x') %>% 
  mutate(intra_diff = x2019-x2010) %>% 
  ggplot() +
  geom_polygon(aes(long, lat, group=group, fill = intra_diff),
               color = 'black') +
  scale_fill_gradient2(high = 'red3') +
  coord_fixed() +
  labs(title = 'Change in intrastate score from 2010 and 2019') +
  theme(panel.background = element_blank(),
        axis.text = element_blank(),
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank())

map_policy_df %>% 
  filter(year %in% c(2010, 2019)) %>% 
  select(-intrastate_score) %>% 
  pivot_wider(names_from = year, values_from = interstate_score, names_prefix = 'x') %>% 
  mutate(inter_diff = x2019-x2010) %>% 
  ggplot() +
  geom_polygon(aes(long, lat, group=group, fill = inter_diff),
               color = 'black') +
  scale_fill_gradient2(high = 'red3') +
  coord_fixed() +
  labs(title = 'Change in interstate score from 2010 and 2019') +
  theme(panel.background = element_blank(),
        axis.text = element_blank(),
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank())

```

```{r play_mods}

combine_all <- policy_scores %>% 
  mutate(state = ifelse(state == 'DC',
                        'District of Columbia',
                        state)) %>% 
  inner_join(abortion_gestation_combined, by = c('year', 'state' = 'state_location')) %>% 
  mutate(across(where(is.character), addNA))

library(lme4)
library(lmerTest)

combine_all_late <- combine_all %>% 
  select(-c(state_residence, total_population)) %>% 
  distinct() %>% 
  mutate(abortions_per_thousand_births = abortions / (births * 1000),
         total_abortions = pre13+post13) 

# fitting a full linear model, even though state and intrastate score are highly
# correlated... model is incredibly poor fit (deviance / df > 200)

summary(full_lm <- glm(post13 ~ offset(log(total_abortions)) + interstate_score + intrastate_score + 
                        abortions_per_thousand_births,
                       family = poisson,
                       data = combine_all_late))
car::vif(full_lm)

full_glmer <- glmer(cbind(post13, pre13) ~ interstate_score + intrastate_score + 
                            (1|year) + (1|state),
                    family = binomial,
                          data = combine_all_late)
fixef(full_glmer)
summary(full_glmer)

```

# Imputation

Missing data from CA could severely bias our model since it's one of the most liberal and populous states. As such, we should impute data. Since the abortion metrics will reasonably depend on several variables in the data -- likely some combination of the location of the procedure, the state of residence, the year in question, policies in the respective states, etc. -- we should explore multivariable imputation. The below methods are worth exploring for this model:

```{r mice}

library(mice)

# 14135 observations without any missing data, 7083 observations with everything
# except abortions, 53 missing only gestational, 5 missing abortions & gestational

md.pattern(combine_all) %>% 
  as.data.frame() %>% 
  rownames_to_column('count')

# once I figure out this package there are ways to aggregate results from the
# model that look very useful

mice(combine_all)

# mice(combine_all)

```

```{r Hmisc}

library(Hmisc)
impute_combined <- aregImpute(~ year + interstate_score + intrastate_score + 
                                abortions + births + total_population + 
                                pre13 + post13 + births,
                              group = combine_all$total_population, 
                              type = 'regression', combine_all, 
                              n.impute = 10, tlinear = FALSE)

# checking r-squared of imputed values... pretty good for gestational breakdown
# but not at all for abortions... it predicts virtually all zeros


```



